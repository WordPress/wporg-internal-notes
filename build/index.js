!function(){var e={472:function(e,t){var n;!function(){"use strict";var r={}.hasOwnProperty;function o(){for(var e=[],t=0;t<arguments.length;t++){var n=arguments[t];if(n){var a=typeof n;if("string"===a||"number"===a)e.push(n);else if(Array.isArray(n)){if(n.length){var l=o.apply(null,n);l&&e.push(l)}}else if("object"===a)if(n.toString===Object.prototype.toString)for(var s in n)r.call(n,s)&&n[s]&&e.push(s);else e.push(n.toString())}}return e.join(" ")}e.exports?(o.default=o,e.exports=o):void 0===(n=function(){return o}.apply(t,[]))||(e.exports=n)}()}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,n),a.exports}n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,{a:t}),t},n.d=function(e,t){for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},function(){"use strict";var e={};n.r(e),n.d(e,{appendNotes:function(){return O},clearIsCreated:function(){return C},createNote:function(){return D},deleteNote:function(){return h},prependNotes:function(){return I},setFilter:function(){return A},setIsDeleted:function(){return b},setNotes:function(){return P}});var t={};n.r(t),n.d(t,{getNotes:function(){return $}});var r={};n.r(r),n.d(r,{getCurrentNotesCount:function(){return Q},getFilter:function(){return J},getLatestNoteDate:function(){return G},getNoteTypes:function(){return K},getNotes:function(){return H},getTotalNotesCount:function(){return W},isCreated:function(){return X},isDeleted:function(){return z}});var o=window.wp.element,a=window.wp.plugins,l=window.wp.components,s=window.wp.compose,i=window.wp.data,c=window.wp.editPost,u=window.wp.i18n,d=window.wp.dataControls;const p={CREATE_NOTE:"CREATE_NOTE",DELETE_NOTE:"DELETE_NOTE",SET_NOTES:"SET_NOTES",PREPEND_NOTES:"PREPEND_NOTES",APPEND_NOTES:"APPEND_NOTES",CLEAR_IS_CREATED:"CLEAR_IS_CREATED",SET_IS_DELETED:"SET_IS_DELETED",SET_FILTER:"SET_FILTER"};var E=window.wp.url;const _=e=>{let{noteId:t,queryArgs:n=[]}=e;const r=(0,i.select)("core/editor").getCurrentPostId(),o=(0,i.select)("core/editor").getCurrentPostType(),{rest_base:a}=(0,i.select)("core").getPostType(o);let l=`/wp/v2/${a}/${r}/internal-notes`;return t&&(l+=`/${t}`),(0,E.addQueryArgs)(l,n)};function*g(e){let{after:t=null,offset:n=0}=e;const r={_embed:!0,context:"edit",per_page:20,offset:n};t&&(r.after=t);const o=yield(0,d.apiFetch)({path:_({queryArgs:r}),parse:!1}),a=yield(0,d.__unstableAwaitPromise)((async e=>{var t;return{totalNotes:Number((null===(t=e.headers)||void 0===t?void 0:t.get("X-WP-Total"))||0),notes:await e.json()}})(o));if(a)return a}const{CREATE_NOTE:m,DELETE_NOTE:f,SET_NOTES:w,PREPEND_NOTES:N,APPEND_NOTES:T,CLEAR_IS_CREATED:S,SET_IS_DELETED:v,SET_FILTER:y}=p;function*D(e){const t=yield(0,d.apiFetch)({path:_({queryArgs:{_embed:!0,context:"edit"}}),method:"POST",data:e});if(t)return{type:m,note:t}}const C=e=>({type:S,noteId:e});function*h(e){if(yield(0,d.apiFetch)({path:_({noteId:e}),method:"DELETE"}))return{type:f,noteId:e}}const b=e=>({type:v,noteId:e});function*P(){const{totalNotes:e,notes:t}=yield g({});return{type:w,totalNotes:e,notes:t}}function*I(e){const{totalNotes:t,notes:n}=yield g({after:e});return{type:N,totalNotes:t,notes:n}}function*O(e){const{notes:t}=yield g({offset:e});return{type:T,notes:t}}const A=e=>({type:y,filter:e}),{CREATE_NOTE:L,DELETE_NOTE:R,SET_NOTES:F,PREPEND_NOTES:x,APPEND_NOTES:k,CLEAR_IS_CREATED:B,SET_IS_DELETED:M,SET_FILTER:j}=p,q={totalNotes:0,notes:[],isCreated:[],isDeleted:[],filter:"all"};function*$(){yield P()}function H(e){return e.notes||[]}function Q(e){return e.notes.length}function W(e){return e.totalNotes}function X(e,t){return e.isCreated.includes(t)}function z(e,t){return e.isDeleted.includes(t)}function G(e){var t;return(null===(t=e.notes.at(0))||void 0===t?void 0:t.date)||""}function J(e){return e.filter}function K(e){const t=e.notes.map((e=>e.type));return[...new Set(t)]}const U=(0,i.createReduxStore)("wporg/internal-notes",{actions:e,controls:d.controls,selectors:r,resolvers:t,reducer:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:q,{note:t,notes:n,noteId:r,totalNotes:o,type:a,filter:l}=arguments.length>1?arguments[1]:void 0;switch(a){case L:return{...e,totalNotes:e.totalNotes+1,notes:[t,...e.notes],isCreated:[...e.isCreated,t.id]};case B:return{...e,isCreated:[...e.isCreated].filter((e=>e!==r))};case R:return{...e,totalNotes:e.totalNotes-1,notes:[...e.notes].filter((e=>e.id!==r)),isDeleted:[...e.isDeleted].filter((e=>e!==r))};case M:return{...e,isDeleted:[...e.isDeleted,r]};case F:return{...e,totalNotes:o,notes:n};case x:const a=n.map((e=>e.id));return{...e,totalNotes:e.totalNotes+o,notes:[...n,...e.notes],isCreated:[...e.isCreated,...a]};case k:const s=n.map((e=>e.id));return{...e,notes:[...e.notes,...n],isCreated:[...e.isCreated,...s]};case j:return{...e,filter:l};default:return e}}});(0,i.register)(U);const V=()=>{const[e,t]=(0,o.useState)(!1),n=(0,i.useSelect)((e=>{const{getCurrentNotesCount:t,getTotalNotesCount:n}=e(U);return{current:t(),total:n()}})),{appendNotes:r,clearIsCreated:a}=(0,i.useDispatch)(U);return(0,o.createElement)(o.Fragment,null,n.total>n.current&&(0,o.createElement)(l.PanelBody,{className:"load-more"},(0,o.createElement)(o.Fragment,null,e&&(0,o.createElement)(l.Spinner,null),!e&&(0,o.createElement)(l.Button,{className:"wporg-internal-notes__button-load-more",text:(0,u.__)("Load older notes","wporg"),isSecondary:!0,onClick:()=>{t(!0),r(n.current).then((e=>{let{notes:n}=e;setTimeout((()=>{n.forEach((e=>{a(e.id)})),t(!1)}),300)}))}}))))},Y=()=>{const{currentFilter:e,hasMultipleTypes:t}=(0,i.useSelect)((e=>{const{getFilter:t,getNoteTypes:n}=e(U);return{currentFilter:t(),hasMultipleTypes:n().length>1}})),{setFilter:n}=(0,i.useDispatch)(U),r={all:(0,u.__)("All Notes","wporg"),"wporg-internal-note":(0,u.__)("Internal Notes","wporg"),"wporg-log-note":(0,u.__)("Log Notes","wporg")},[a,s]=(0,o.useState)(r[e]),c=[{title:r.all,disabled:"all"===e,onClick:()=>{n("all"),s(r.all)}},{title:r["wporg-internal-note"],disabled:"wporg-internal-note"===e,onClick:()=>{n("wporg-internal-note"),s(r["wporg-internal-note"])}},{title:r["wporg-log-note"],disabled:"wporg-log-note"===e,onClick:()=>{n("wporg-log-note"),s(r["wporg-log-note"])}}];return(0,o.createElement)(o.Fragment,null,t&&(0,o.createElement)(l.DropdownMenu,{className:"wporg-internal-notes__filter",icon:"filter",label:(0,u.__)("Filter notes","wporg"),text:a,controls:c}))},Z=()=>{const[e,t]=(0,o.useState)(!1),[n,r]=(0,o.useState)(!1),[a,s]=(0,o.useState)(""),{clearIsCreated:c,createNote:d}=(0,i.useDispatch)(U),p=(0,i.useSelect)((e=>e(U).getFilter()));return(0,o.createElement)(l.PanelBody,{className:"wporg-internal-notes__note-form"},e&&(0,o.createElement)(o.Fragment,null,"wporg-log-note"===p&&(0,o.createElement)(l.Notice,{status:"warning",isDismissible:!1},(0,u.__)("Internal notes are currently hidden by the filter.","wporg")),(0,o.createElement)(l.TextareaControl,{className:"wporg-internal-notes__note-form-textarea",label:(0,u.__)("Add a note","wporg"),value:a,onChange:e=>s(e),rows:"2",disabled:n}),(0,o.createElement)("div",{className:"wporg-internal-notes__note-form-buttons"},n&&(0,o.createElement)(l.Spinner,null),!n&&(0,o.createElement)(o.Fragment,null,(0,o.createElement)(l.Button,{className:"wporg-internal-notes__note-form-button-cancel",text:(0,u.__)("Cancel","wporg"),onClick:e=>{e.preventDefault(),t(!1)},isSecondary:!0}),(0,o.createElement)(l.Button,{className:"wporg-internal-notes__note-form-button-submit",text:(0,u.__)("Submit","wporg"),onClick:()=>{a.length&&(r(!0),d({excerpt:a}).then((e=>{let{note:t}=e;s(""),r(!1),setTimeout((()=>{c(t.id)}),300)})))},isPrimary:!0})))),!e&&(0,o.createElement)(l.PanelRow,null,(0,o.createElement)(l.Button,{className:"wporg-internal-notes__note-form-button-toggle",text:(0,u.__)("Add a note","wporg"),onClick:()=>{t(!0)},isPrimary:!0}),(0,o.createElement)(Y,null)))};var ee=n(472),te=n.n(ee);const ne=e=>{let{noteId:t}=e;const[n,r]=(0,o.useState)(!1),{deleteNote:a,setIsDeleted:c}=(0,i.useDispatch)(U),d=(0,s.useRefEffect)((e=>{const{ownerDocument:t}=e,n=t=>{e&&!e.contains(t.target)&&r(!1)};return t.addEventListener("mousedown",n),()=>{t.removeEventListener("mousedown",n)}}),[]);return(0,o.createElement)(o.Fragment,null,!n&&(0,o.createElement)(l.Button,{className:"wporg-internal-notes__note-button-delete",label:(0,u.__)("Delete note","wporg"),icon:"trash",isSecondary:!0,onClick:()=>{r(!0)}}),n&&(0,o.createElement)(l.Button,{ref:d,className:"wporg-internal-notes__note-button-confirm-delete",isDestructive:!0,onClick:()=>{c(t),setTimeout((()=>{a(t)}),300)}},(0,u.__)("Delete this note?","wporg")))},re=e=>{var t,n,r,a;let{className:l,note:s}=e;const{id:c,date_gmt:d,date_relative:p,type:E}=s,_=null==s||null===(t=s._embedded)||void 0===t||null===(n=t.author)||void 0===n?void 0:n[0],g=(null==_||null===(r=_.avatar_urls)||void 0===r?void 0:r[24])||"",m=(null==_?void 0:_.slug)||"unknown",f=null==s||null===(a=s.excerpt)||void 0===a?void 0:a.rendered,{isCreated:w,isDeleted:N}=(0,i.useSelect)((e=>{const{isCreated:t,isDeleted:n}=e(U);return{isCreated:t(s.id),isDeleted:n(s.id)}}),[s]);if(!p||!f)return(0,o.createElement)("li",{className:te()("wporg-internal-notes__note","is-error",l)},(0,u.__)("Missing data.","wporg"));const T=te()("wporg-internal-notes__note",{"internal-note":"wporg-internal-note"===E,"log-note":"wporg-log-note"===E,"is-created":w,"is-deleted":N},l);return"wporg-log-note"===E?(0,o.createElement)("li",{className:T},(0,o.createElement)(o.RawHTML,{className:"wporg-internal-notes__note-excerpt"},f),(0,o.createElement)("footer",{className:"wporg-internal-notes__note-footer"},(0,o.createElement)("time",{className:"wporg-internal-notes__note-date",title:d,dateTime:d},p),(0,o.createElement)("a",{className:"wporg-internal-notes__note-author-name",href:(0,u.sprintf)("https://profiles.wordpress.org/%s",m),target:"_blank",rel:"noreferrer"},(0,u.sprintf)("@%s",m)))):(0,o.createElement)("li",{className:T},(0,o.createElement)("header",{className:"wporg-internal-notes__note-header"},(0,o.createElement)("div",{className:"wporg-internal-notes__note-author"},g&&(0,o.createElement)("img",{className:"wporg-internal-notes__note-author-avatar",src:g,alt:""}),(0,o.createElement)("a",{className:"wporg-internal-notes__note-author-name",href:(0,u.sprintf)("https://profiles.wordpress.org/%s",m),target:"_blank",rel:"noreferrer"},(0,u.sprintf)("@%s",m))),(0,o.createElement)(ne,{noteId:c})),(0,o.createElement)(o.RawHTML,{className:"wporg-internal-notes__note-excerpt"},f),(0,o.createElement)("footer",{className:"wporg-internal-notes__note-footer"},(0,o.createElement)("time",{className:"wporg-internal-notes__note-date",title:d,dateTime:d},p)))},oe=e=>{let{notes:t}=e;const n=(0,i.useSelect)((e=>e(U).getFilter())),r=te()("wporg-internal-notes__notes-list","filter-"+n);return(0,o.createElement)("ul",{className:r},t.map((e=>(0,o.createElement)(re,{key:e.id,note:e}))))},ae=()=>{const{getTotalNotesCount:e}=(0,i.useSelect)((e=>e(U)));return(0,o.createElement)("div",{className:"wporg-internal-notes__sidebar-icon"},(0,o.createElement)("span",{className:"note-count"},e().toLocaleString()),(0,o.createElement)(l.Icon,{icon:"edit-page"}))},le=()=>{const{initialNotes:e,afterDate:t,isSaving:n}=(0,i.useSelect)((e=>({initialNotes:e(U).getNotes(),afterDate:e(U).getLatestNoteDate(),isSaving:e("core/editor").isSavingPost()}))),{prependNotes:r,clearIsCreated:a}=(0,i.useDispatch)(U),d=(0,s.usePrevious)(n),[p,E]=(0,o.useState)(!1);return(0,o.useEffect)((()=>{d&&!n&&(E(!0),r(t).then((e=>{let{notes:t}=e;E(!1),setTimeout((()=>{t.forEach((e=>{a(e.id)}))}),300)})))}),[n,d]),(0,o.createElement)(c.PluginSidebar,{name:"wporg-internal-notes__sidebar",className:"wporg-internal-notes__sidebar",title:(0,u.__)("Internal Notes","wporg"),icon:(0,o.createElement)(ae,null)},(0,o.createElement)(Z,null),p&&(0,o.createElement)(l.PanelBody,null,(0,o.createElement)(l.Spinner,null)),(0,o.createElement)(oe,{notes:e}),(0,o.createElement)(V,null))};(0,a.registerPlugin)("wporg-internal-notes",{render:()=>(0,o.createElement)(le,null)})}()}();